<!DOCTYPE html> 
<html> 
  <head> 
  <title>Class Tempo</title> 
  <meta name="viewport" content="height=100%,width=device-width,initial-scale=1.0,maximum-scale=1.0, user-scalable=0" >
    <!-- CSS -->
  <link rel="stylesheet" href="./signup.css">
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.1/jquery.mobile-1.1.1.min.css" />
  <link rel="stylesheet" type="text/css" href="simpleDialog2/jquery.mobile.simpledialog.min.css" /> 

  <!-- Modernizer -->
  <script type="text/javascript" src="./modernizr.custom.56582.js"></script>
  <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
  <script src="http://code.jquery.com/mobile/1.1.1/jquery.mobile-1.1.1.min.js"></script>

   <!-- simpleDiaglo2 -->
  <script src="simpleDialog2/jquery.mobile.simpledialog2.min.js"></script>

</head> 
<body> 

<!-- Page starts here -->
<div data-role="page" data-theme="a" id="surveyCreatorPage" data-add-back-btn="true"> 

  <script>   
   // Global declarations - assignments made in $(document).ready() below
    var surveyCreatorContentVar = null;

    var sliderValue = null;
    var surveyType = null;
    var onOffValue = null;
    var surveyDescriptionVar = null;

    var surveyCreatorFormVar = null;

    var MISSING = "missing";
    var EMPTY = "";

  </script>

<div id="surveyCreatorContainer">

  <div data-role="header" id="hdrMain">
    <a href="" onclick="logMeOut()" data-direction="reverse" rel="external" data-icon="" data-transition="slide" class="ui-btn-right">Logout</a>
    <h1>Class Tempo</h1>
  </div>

<div data-role="content" id="surveyCreatorContent">

  <form id="surveyCreatorForm">

  <div id="optionSliderDiv" data-role="fieldcontain">
    <label for="optionSlider">How Many Options?</label>
    <input type="range" name="optionSlider" id="optionSlider" value="2" min="2" max="25" data-highlight="true" />
  </div>

  <div id="surveyViewer">
  </div>

  <fieldset data-role="controlgroup">
  <legend>Survey On/Off</legend>
      <input type="radio" name="OnOff" id="On" value="On" checked="checked" />
      <label for="On">Survey On</label>

      <input type="radio" name="OnOff" id="Off" value="Off"  />
      <label for="Off">Survey Off</label>
  </fieldset>

  <div data-role="fieldcontain">
    <label for="SurveyDescription">Survey Description:</label>
    <textarea name="SurveyDescription" id="SurveyDescription"></textarea>
  </div>

    <div id="createSurveyButtonDiv">    
    <a id="createSurveyButton" name="createSurveyButton" data-role="button" data-inline="true" data-ajax="false">Create Survey</a>
    </div>
    </form>
  </div>
</div>

  <div id="footer" data-role="footer">
  </div>

<script>

/* Convenience Methods and page set-up */

$(document).bind('mobileinit',function(){
        $.mobile.selectmenu.prototype.options.nativeMenu = false;
  });

function showSimpleDialogue(alertHeader, alertMessage) {
    
    $(document).simpledialog2({
                    mode: 'button',
                    headerText: alertHeader,
                    buttonPrompt: alertMessage,
                    headerClose: false,
                    buttons : {
                      'OK': {
                        click: function () { 
                        }
                      }
                    }
             })
 }

$(document).delegate('#surveyCreatorPage', 'pageshow', function () {
    var the_height = ($(window).height() - $(this).find('[data-role="header"]').height() - $(this).find('[data-role="footer"]').height());
    $(this).height($(window).height()).find('[data-role="content"]').height(the_height);
  });

function logMeOut(){
      
      if (Modernizr.sessionstorage) {
        sessionStorage.loggedIn = 'false';
      }
      else {
        $.cookie("loggedIn","false");
      }

      $.mobile.changePage("teacher.html",{transition:"fade"});
    }
 
/* DOCUMENT READY */

$(document).ready(function() {

});

 $('#surveyCreatorPage').on('pageinit', function() {
      $('#surveyCreatorPage').css('height', $(document).height());
    
    var sessionActive;

    if (Modernizr.sessionstorage){
        if (sessionStorage.loggedIn === 'true'){sessionActive = true;}
        else {sessionActive = false;}
    }
    else {
        if ($.cookie("loggedIn") === 'true'){sessionActive = true;}
        else {sessionActive = false;}
    }

    if (sessionActive === false){
      $('#surveyCreatorContainer').remove();
      showSimpleDialogue("Whoops!","Looks like you're logged out.");
    }

      surveyCreatorContentVar = $('#surveyCreatorContent');
      surveyDescriptionVar = $('#SurveyDescription')
      surveyCreatorFormVar = $('#surveyCreatorForm');
      sliderValue = $('#optionSlider');


       //check the navigator.userAgent string to detect if the user is using an iPhone
    if (navigator.userAgent.match(/iPhone/i)) {

        //cache the viewport tag if the user is using an iPhone
        var $viewport = $('head').children('meta[name="viewport"]');

        //bind an event handler to the window object for the orientationchange event
        $(window).bind('orientationchange', function() {
            if (window.orientation == 90 || window.orientation == -90 || window.orientation == 270) {

                //landscape
                $viewport.attr('content', 'height=device-width,width=device-height,initial-scale=1.0,maximum-scale=1.0');
            } else {

                //portrait
                $viewport.attr('content', 'height=device-height,width=device-width,initial-scale=1.0,maximum-scale=1.0');
            }

        //trigger an orientationchange event on the window object to initialize this code (basically in-case the user opens the page in landscape mode)
        }).trigger('orientationchange');
      }
/* CHANGE LATER IF PROVIDING FUNCTIONALITY FOR PICKING FIST LETTER 

              $('#startingNumberOrLetter').append('<div data-role="fieldcontain"><label for="lettersMenu" class="select">Select Letter:</label><select name="lettersMenu" id="lettersMenu" data-native-menu="false">');

              var beginLastAppend;
              var alphabet = ['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z'];

              for (var i = 0; i < alphabet.length; i++) {
                $('#lettersMenu').append('<option value=\'' + alphabet[i] + '\'>' + alphabet[i] + '</option>');
              }

*/
// Set up Survey Viewer
        if (sessionStorage.surveyType === 'Numbers'){
            $('#surveyViewer').append('<input type="radio" name="options" id="1" value="1" /></input><input type="radio" name="options" id="2" value="2" />');
        }
        else if (sessionStorage.surveyType === 'Letters') {
            $('#surveyViewer').append('<input type="radio" name="options" id="a" value="a" /></input><input type="radio" name="options" id="b" value="b" />');
          }
        else if (sessionStorage.surveyType === 'Custom') {

          var numberOfCustomOptions;

          if (sessionStorage.numCustom === undefined)
                numberOfCustomOptions = 1;
          else
                numberOfCustomOptions = parseInt(sessionStorage.numCustom);

          for (var i = 0; i < numberOfCustomOptions; i++) {
            $('ul#customOptionsList').append('<li><label for="custom' + (i+1) + '" class="ui-input-text">Option ' + (i+1) + ':</label><input type="text" name="custom' + (i+1) + '" id="custom' + (i+1) + '" value="" class="ui-input-text ui-body-c ui-corner-all ui-shadow-inset"></li>');
          }
        }

        // Initiate surveyType
        if (Modernizr.sessionstorage) {
          surveyType = sessionStorage.surveyType;
        }
        else {
          surveyType = $.cookie("surveyType");
        }
  
    $("input[type='radio']").prop("checked",false).checkboxradio("refresh");
      // $('#lettersMenu').selectmenu('refresh',true);
});

 $('#optionSlider').live('change', function() {
        sliderValue = $(this).slider();

        $('#surveyViewer').empty();

        if (surveyType === 'Numbers')
        {
        for (i = 1; i <= sliderValue; i++){

          $('#surveyViewer').append('<input type="radio" name="options" id="' + i + '" value="' + i + '" />');
              // $('#optionsList').append('<label for="' + i + '" >' + i + '</label>');
          }
        }
        else if (surveyType === 'Letters') {

          var alphabet = ['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z'];

          for (i = 0; i < sliderValue; i++){
  
          $('#surveyViewer').append('<input type="radio" name="options" id="' +alphabet[i] + '" value="' + alphabet[i] + '" />');
              // $('#optionsList').append('<label for="' + alphabet[i] + '" >' + alphabet[i] + '</label>');
          }
        }
        $("input[type='radio']").prop("checked",false).checkboxradio("refresh");
});
   
    
$('#createSurveyButton').click(function() { 

        $('input[name=OnOff]').each(function() { 
            onOffValue = $('input[name=OnOff]:checked').val();
        })

        var currentEmailVar;
        var currentUserTagVar;

          if (Modernizr.sessionstorage) {
              currentEmailVar = sessionStorage.emailVar;
              currentUserTagVar = sessionStorage.userTagVar;
          } 
         else {
               currentEmailVar = $.cookie("emailVar");
              currentUserTagVar = $.cookie("userTagVar");
           }

        // Submit the form
        $.post("/Survey_app/survey_phpScripts/createSurvey.php?userAuthKey=" + currentUserTagVar + "&numberOfOptions=" + sliderValue.val() + " &surveyType=" + surveyType + "&onOff=" + onOffValue + "&surveyDescription=" + surveyDescriptionVar.val() + "&email=" + currentEmailVar, surveyCreatorFormVar.serialize(), function(data){
          
          console.log(data);
          if (data != 'Error') {

            if (Modernizr.sessionstorage) {
              sessionStorage.surveyTag = data;
            }
            else {
              $.cookie("surveyTag",data);
            }

            // If we have created a survey successfully go to it's analytics page
            $.mobile.changePage( "surveyResults.html", { transition : "slide"});
          }
          else {
            // show some kind of error message to inform user that there was a problem
            // in creating survey    
          }
        });        
        return false;      
    });   
    
  </script>
</div> <!-- page1 -->


<!-- Page ends here -->
</body>
</html>
