<!DOCTYPE html> 
<html> 
  <head> 
    <meta http-equiv="refresh" content="20">
      <meta name="viewport" content="height=device-height,width=device-width,initial-scale=1.0,maximum-scale=1.0" >
  <title>Class Tempo: Survey Results</title> 
  
  <!-- CSS -->
  <link rel="stylesheet" href="./signup.css">
    <link rel="stylesheet" href="./teacher-theme/themes/Class-Tempo-Teacher.min.css" />
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.1/jquery.mobile.structure-1.1.1.min.css" />
<!--   <link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.1/jquery.mobile-1.1.1.min.css" /> -->
    <link rel="stylesheet" type="text/css" href="simpleDialog2/jquery.mobile.simpledialog.min.css" />  
  
  <!-- Modernizer -->
  <script type="text/javascript" src="./modernizr.custom.56582.js"></script>
  
  <!-- jQuery/jQuery Mobile -->
  <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
  <script src="http://code.jquery.com/mobile/1.1.1/jquery.mobile-1.1.1.min.js"></script>
  
  <!-- jqPlot -->
  <!--[if lt IE 9]><script language="javascript" type="text/javascript" src="js/excanvas.js"></script><![endif]-->
  <script language="javascript" type="text/javascript" src="js/jquery.jqplot.min.js"></script>
  <link rel="stylesheet" type="text/css" href="js/jquery.jqplot.css" />

  <script language="javascript" type="text/javascript" src="js/plugins/jqplot.barRenderer.js"></script>
  <script language="javascript" type="text/javascript" src="js/plugins/jqplot.barRenderer.min.js"></script>
  <script language="javascript" type="text/javascript" src="js/plugins/jqplot.categoryAxisRenderer.js"></script>
  <script language="javascript" type="text/javascript" src="js/plugins/jqplot.pointLabels.js"></script>
  <script language="javascript" type="text/javascript" src="js/plugins/jqplot.pointLabels.min.js"></script>
  <script type="text/javascript" src="../js/plugins/jqplot.pieRenderer.min.js"></script>
  <script type="text/javascript" src="../js/plugins/jqplot.donutRenderer.min.js"></script>

</head> 


<body> 

<!-- Page starts here -->
<div data-role="page" data-theme="a" id="surveyResultsPage" data-add-back-btn="true">

<script>

// Definition of Global Variable
  var surveyType = null;
  var surveyTag = null;
  var surveyClass = null;
  var surveyDescription = null;

</script>

<style>
  #chart1 {
    width:98%;
    height: 30%;
  }
  #onOffSection {
    margin-top:10px;
  }

</style>

  <div data-role="header" id="hdrMain" name="hdrMain">
     <a href="mySurveys.html" data-direction="reverse" rel="external" data-icon="back" data-transition="slide" class="ui-btn-left">Back</a>

    <h1>Class Tempo</h1>
    <a href="surveyResults.html" rel="external" data-icon="refresh" class="ui-btn-right">refresh</a>
  </div>

  <div data-role="content" id="surveyCreatorContent" name="surveyCreatorContent"> 
      
      <div id="chart1" style="">
      </div>

      <div id="specificResponseMatching">
      <ul id="matchingResults" data-role="listview" data-inset="true">
      </ul>
      </div>

      <div id="specificResponseFree">
      <ul id="freeResults" data-role="listview" data-inset="true">
      </ul>
      </div>

      <audio id="alertNoise" hidden="true" src="alarmsound.wav" controls preload="auto" autobuffer></audio>

      <div id="classDiv">
        <label><strong>Class:</strong></label>
        <p id="classParagraph"></p>
      </div>

      <div id="surveyDescription">
        <label><strong>Description:</strong></label>
        <p id="descriptionParagraph"></p>
      </div>

      <div id="onOffSection">
      <label for="surveyOnOff" ><strong>On/off:</strong></label>
      <select name="surveyOnOff" id="surveyOnOff" data-role="slider" data-theme="c" data-track-theme="a">
        <option value="off">Off</option>
        <option value="on">On</option>
      </select>
    </div>

  
  </div><!-- contentMain -->
  
  <div data-role="footer" id="ftrMain" name="ftrMain"></div>

  <script>

function returnTicks(results){
        var ticks = [];
        var surveyType;

      if (Modernizr.sessionstorage){
            surveyType = sessionStorage.surveyType;
      }
      else {
            surveyType = $.cookie("surveyType");
      }

          if (surveyType === 'Numbers') {

              for (var i = 0; i < results.length; i++){
                  ticks.push(i+1);
              }
          }
          else if (surveyType === 'Letters') {
            var alphabet = ['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z'];

            // Add ticks for the x-axis
            ticks = alphabet.slice(0,results.length);
          }
        
        return ticks;    
}

$('#surveyResultsPage').on('pageinit', function() {


  /* *************** Set Local Variable *************** */
           if (Modernizr.sessionstorage) {
                  surveyTag = sessionStorage.surveyTag;
                  surveyType = sessionStorage.surveyType;
                  surveyClass = sessionStorage.surveyClass;
                  surveyDescription = sessionStorage.surveyDescription;
          }
          else {
                  surveyTag = $.cookie("surveyTag");
                  surveyType = $.cookie("surveyType");
                  surveyClass = $.cookie("surveyClass");
                  surveyDescription = $.cookie("surveyDescription");
          }

      
      /* *************** Set Class/Description for Survey *************** */
      // set class
      if (surveyClass === '') {
        $('#classParagraph').append('Other');
      }
      else {
        $('#classParagraph').append(surveyClass);
      }

      // set description
      if (surveyDescription === '') {
        $('#descriptionParagraph').append('N/A');
      }
      else {
        $('#descriptionParagraph').append(surveyDescription);
      }

           // Load Graph 
           $.getJSON("/Survey_app/survey_phpScripts/getSurveyAnalytics.php?surveyAuthKey=" + surveyTag + "&surveyType=" + surveyType, function(json) {
            
            /* ************************* Tempo Survey ******************* */
          if (surveyType === 'Tempo') {
            
            var hits = json.Results[0].Hits;
            var classSize = json.Results[0].Class_size;
            var hitsPercent = (hits/classSize) * 100;
            var tooFastPercentDecimal = (json.Results[0].Percent) / 100;
            var tooFastPercentWholeNumber = json.Results[0].Percent;


            var restOfClassPercent = 100 - hitsPercent;

            console.log("json.results: ",json.Results[0]);
            console.log("tooFastPercent ",tooFastPercentDecimal);
            console.log("restOfClassPercent: ",restOfClassPercent);


            var data = [['', restOfClassPercent],['Too Fast', hitsPercent]];
            var plot2 = jQuery.jqplot ('chart1', [data], 
              {
                seriesDefaults: {
                  renderer: jQuery.jqplot.PieRenderer, 
                  rendererOptions: {
                    // Turn off filling of slices.
                    fill: false,
                    showDataLabels: true, 
                    // Add a margin to seperate the slices.
                    sliceMargin: 4, 
                    // stroke the slices with a little thicker line.
                    lineWidth: 5,
                    seriesColors: $.merge([ "#55A9D3", "#EA2E49", "#EA2E49"], $.jqplot.config.defaultColors)
                  }
                }, 
                legend: { show:true, location: 'e' }
              }
            );



            if ((hits/classSize) >= tooFastPercentDecimal) {
              // play sound
              document.getElementById('alertNoise').play()
            }
          } /* ******** Numbers/Letters/Custom Survey ******** */
            else if (surveyType !== 'Specific') {

              $.jqplot.config.enablePlugins = true;

              // Define local variables used to create graph
              var arrayOfValues = json.Results[0];
              var arrayOfPercents = json.Results[1];
              var arrayOfPointLabels = [];  
             // var ticks = returnTicks(json.Results[0]);
              var ticks;

              if ((surveyType === 'Numbers') || (surveyType === 'Letters')) {
                 ticks = returnTicks(json.Results[0]);
               }
              else if (surveyType === 'Custom') {
                 ticks = json.Results[2];
               }

              // Add Point Labels
              for (var i = 0; i < arrayOfValues.length; i++){
                  arrayOfPointLabels.push(arrayOfValues[i] + ", " + arrayOfPercents[i]);
              }

              // Get array of ints to actually plot data
              var arrayOfValuesNumbers = arrayOfValues.map(Number);;

              plot1 = $.jqplot('chart1', [arrayOfValuesNumbers], {
                  // Only animate if we're not using excanvas (not in IE 7 or IE 8)..
                  animate: !$.jqplot.use_excanvas,
                  title: sessionStorage.surveyTag + ' Results',
                  seriesDefaults:{
                      renderer:$.jqplot.BarRenderer,
                      rendererOptions:{ 
                        varyBarColor : true ,
                      animation: {speed: 1000} },
                      pointLabels: {show: true}
                  },
                  series:[
                    {pointLabels:{
                                  show: true,
                                  labels:arrayOfPointLabels,
                                  ypadding: 12,
                                }}],
                  axes: {
                      xaxis: {
                          renderer: $.jqplot.CategoryAxisRenderer,
                          ticks: ticks
                      }
                  },
                  highlighter: { show: false },
                  seriesColors: $.merge([ "#55A9D3", "#D4EDE2", "#EA2E49"], $.jqplot.config.defaultColors)
              });
          }
          else {  /* ************* Specific Response Survey ************* */
           
            var matching = json.Results[0];

            if (matching === 0) { // If this specific survey is matching

            var matchingResponse = json.Results[1];
            var allResponses = json.Results[2];
            var allHits = json.Results[3];
            var correctWrong = json.Results[4];
            var percentArray = json.Results[5];


                $('#matchingResults').children().remove('li');

                $('ul#matchingResults').append('<li data-role="list-divider">Results</li>');
                $('ul#matchingResults').append('<li>Matching Value: ' + matchingResponse + '</li>');
                $('ul#matchingResults').append('<li>Correct: ' + correctWrong[0] + ' (' + percentArray[0] + ')</li>');
                $('ul#matchingResults').append('<li>Wrong: ' + correctWrong[1] + ' (' + percentArray[1] + ')</li>');

                $('ul#matchingResults').append('<li data-role="list-divider">All Responses</li>');

                for (i = 0; i < allResponses.length; i++) {
                    $('ul#matchingResults').append('<li>' + allResponses[i] + ': ' + allHits[i] + '</li>');
                }


                $('ul#matchingResults').listview();
                $('ul#matchingResults').listview('refresh');
              }
              else { // Otherwise, just list all of the responses

                var allResponses = json.Results[1];
                var allHits = json.Results[2];

                $('#freeResults').children().remove('li');

                $('ul#freeResults').append('<li data-role="list-divider">Results</li>');

                if (allResponses.length === 0) {
                  $('ul#freeResults').append('<li>No responses yet...</li>');
                }
                else {

                  for (i = 0; i < allResponses.length; i++) {
                    $('ul#freeResults').append('<li>' + allResponses[i] + ': ' + allHits[i] + '</li>');
                  }
                }

                $('ul#freeResults').listview();
                $('ul#freeResults').listview('refresh');
              }
          }

                // set On or Off
                if (Modernizr.sessionstorage) {
                    var onOffValue = sessionStorage.onOffValue;
                }
                else {
                  var onOffValue = $.cookie("onOffValue");
                }

                if (onOffValue === 'On')
                  $('#surveyOnOff').val('on').slider("refresh");
                else
                  $('#surveyOnOff').val('off').slider("refresh");
             
             }); // END JSON CALLBACK
  });

    $('#surveyOnOff').change(function() {

      var currentOnOffValue;
      
      if ($('#surveyOnOff').val() === 'on')
        currentOnOffValue = 0;
      else
        currentOnOffValue = 1;

     $.post("/Survey_app/survey_phpScripts/set_survey_onOff.php?surveyID=" + surveyId + "&onOff=" + currentOnOffValue,function(response){

     });
    });

  </script>
</div> <!-- page1 -->


<!-- Page ends here -->
</body>
</html>
